datasource db {
  provider = "postgresql"
  url       = env("POSTGRES_URL_NON_POOLING")             // pooling(6543)
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id             String   @id @default(cuid())
  createdAt      DateTime @default(now())
  guestId        String?  @unique
  walletAddress  String?  @unique
  walletVerifiedAt DateTime?
  inviteCode     String?  @unique
  gachaTickets   Int      @default(3)
  totalLikesUsed Int      @default(0)
  ornamentBalance Int     @default(0)
  lastOrnamentAttachedAt DateTime?

  trees            Tree[]
  ornaments        Ornament[]
  likes            Like[]
  referralsSent    Referral[] @relation("Referrer")
  referredBy       Referral?  @relation("Referred", fields: [referredById], references: [id])
  referredById     String?  @unique
  rewards          Reward[]
  payments         Payment[]
  ornamentAudits   OrnamentAudit[]
  rewardClaims     RewardClaim[]
  characterReports CharacterReport[]
  ornamentMintQueues OrnamentMintQueue[]
}

model Tree {
  id          String     @id @default(cuid())
  ownerId     String
  owner       User       @relation(fields: [ownerId], references: [id])
  background  String
  shape       String
  status      TreeStatus @default(DRAFT)
  likeCount   Int        @default(0)
  completedAt DateTime?
  createdAt   DateTime   @default(now())
  shareCode   String?    @unique
  metadataUri String?
  characterReportId String?
  characterReport   CharacterReport? @relation(fields: [characterReportId], references: [id])
  sloganId     Int?
  sloganCustom String?
  pinnedOrnamentIds Json?

  ornaments Ornament[]
  likes     Like[]
  referrals Referral[]
  ornamentAudits OrnamentAudit[]
}

enum TreeStatus {
  DRAFT
  COMPLETED
}

model Ornament {
  id        String       @id @default(cuid())
  treeId    String
  tree      Tree         @relation(fields: [treeId], references: [id])
  ownerId   String
  owner     User         @relation(fields: [ownerId], references: [id])
  type      OrnamentType
  imageUrl  String
  slotIndex Int
  createdAt DateTime     @default(now())
  tagId     Int?
  tagText   String?

  audits OrnamentAudit[]

  @@unique([treeId, slotIndex])
}

enum OrnamentType {
  FREE_GACHA
  PAID_UPLOAD
}

model Like {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  treeId    String
  tree      Tree     @relation(fields: [treeId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, treeId])
}

model Referral {
  id           String   @id @default(cuid())
  referrerId   String
  referrer     User     @relation("Referrer", fields: [referrerId], references: [id])
  referredUser User?    @relation("Referred")
  createdAt    DateTime @default(now())
  code         String   @unique
  treeId       String?
  tree         Tree?    @relation(fields: [treeId], references: [id])
}

model Reward {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  amount    String
  claimed   Boolean  @default(false)
  createdAt DateTime @default(now())

  claims RewardClaim[]
}

model Payment {
  id                String        @id @default(cuid())
  userId            String
  user              User          @relation(fields: [userId], references: [id])
  amountCents       Int
  currency          String        @default("USD")
  paymentType       PaymentType
  provider          String        @default("internal")
  providerPaymentId String?
  status            PaymentStatus @default(PENDING)
  metadata          Json?
  createdAt         DateTime      @default(now())

  ornamentAudits OrnamentAudit[]
}

model OrnamentAudit {
  id           String            @id @default(cuid())
  ornamentId   String?
  ornament     Ornament?         @relation(fields: [ornamentId], references: [id])
  treeId       String?
  tree         Tree?             @relation(fields: [treeId], references: [id])
  actorId      String
  actor        User              @relation(fields: [actorId], references: [id])
  action       OrnamentAuditType
  paymentId    String?
  payment      Payment?          @relation(fields: [paymentId], references: [id])
  detail       Json?
  createdAt    DateTime          @default(now())
}

model RewardClaim {
  id         String      @id @default(cuid())
  rewardId   String
  reward     Reward      @relation(fields: [rewardId], references: [id])
  userId     String
  user       User        @relation(fields: [userId], references: [id])
  wallet     String
  txHash     String?
  claimedAt  DateTime    @default(now())
  status     ClaimStatus @default(PENDING)
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentType {
  GACHA_TICKET_PURCHASE
  PREMIUM_UPLOAD
  ORNAMENT_DELETE
  DIRECT_TOP_UP
}

enum OrnamentAuditType {
  CREATED_FREE_GACHA
  CREATED_PAID_UPLOAD
  DELETED_BY_OWNER
  DELETED_BY_ADMIN
}

enum ClaimStatus {
  PENDING
  SUCCESS
  FAILED
}

model CharacterReport {
  id            String   @id @default(cuid())
  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  walletAddress String
  characterType String
  emoji         String?
  label         String?
  description   String?
  metrics       Json?
  issuedYear    Int?
  createdAt     DateTime @default(now())

  trees Tree[]
}

model OrnamentMintQueue {
  id           String               @id @default(cuid())
  userId       String
  walletAddress String
  tokenId      Int
  amount       Int                  @default(1)
  status       OrnamentMintStatus   @default(PENDING)
  error        String?
  txHash       String?
  ornamentId   String?
  imageUrl     String?
  metadataUri  String?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  processedAt  DateTime?

  user         User                 @relation(fields: [userId], references: [id])
}

enum OrnamentMintStatus {
  PENDING
  PROCESSING
  SENT
  FAILED
}
